<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="jquery.mobile-1.4.5/jquery.mobile-1.4.5.min.css" />
<link rel="stylesheet" href="homebridge-punt.css" />
<script src="jquery-2.1.4.min.js"></script>
<script src="jquery.mobile-1.4.5/jquery.mobile-1.4.5.min.js"></script>
<script>
var ws;

$(document).on("pagecreate", "#page1", function() {
  var header = document.getElementById("header");
  $(header).html('<h3 class="msg">Simulator  <span id="h-status"></span></h3>');
  $(document).ready(startWS);
});

function startWS() {
  var origin = window.document.location.origin.replace(/http/, 'ws');
  ws = new WebSocket(origin);
  ws.onopen = function (event) {
    displayMessage("#h-status", "connected", "YellowGreen");
  }
  ws.onclose = function (event) {
    displayMessage("#h-status", "disconnected", "Tomato");
  }
  ws.onmessage = function (event) {
    //displayMessage("#message", event.data, "YellowGreen")
    var j_data = JSON.parse(event.data);
    switch (j_data.label.data_type) {
      case "info":
        var footer = document.getElementById("footer");
        $(footer).html('<h3>homebridge-punt <span id="version"></span></h3>');
        displayMessage("#version", "v"+j_data.label.version, "SteelBlue");
      break;
      case "value":
        updateView(j_data);
      break;
    }
  }
  ws.onerror = function (event) {
    displayMessage("#error_msg", event.data, "red");
  }
}

function displayMessage(output, message, color) {
  $(output).html('<span style="color:' + color + '">' + message + '</span>');
}

function updateView(data) {
  //displayMessage("#message", JSON.stringify(data), "SteelBlue");
  var data_view = document.getElementById('data_view');
  if (!data_view) {
    createView(data);
    for (i = 0; i < data.accessories.length; i++) {
      parsing(i,data.accessories[i].value);
    }
  } else {
    var value;
    if (data.label.index == "all") {
      for (i = 0; i < data.accessories.length; i++) {
        parsing(i,data.accessories[i].value);
      }
    } else {
      var i = data.label.index;
      parsing(i,data.accessory.value);
    }
  }
}

function parsing(i, value) {
  if (jQuery.type(value.On) === "boolean") {
    setBtnColor(i, value.On);
  }
  if (jQuery.type(value.CurrentTemperature) === "number") {
    var ct = value.CurrentTemperature.toFixed(1);
    var temp = document.getElementById("temp"+i);
    $(temp).val(ct);
  }
}

function setBtnColor(i, value) {
  var btn_off = document.getElementById("btn_off"+i);
  var btn_on = document.getElementById("btn_on"+i);
  if (value) {
    $(btn_on).addClass("btn_tap");
    $(btn_off).removeClass("btn_tap");
  } else {
    $(btn_off).addClass("btn_tap");
    $(btn_on).removeClass("btn_tap");
  }
}

function createView(data) {
  //displayMessage("#message", JSON.stringify(data), "SteelBlue");
  var grid = $('<div class="ui-grid-a ui-responsive" id="data_view">');
  var ba = '<div class="ui-block-a">';
  var bb = '<div class="ui-block-b">';
  var be = '</div>';
  var block_a;
  var block_b;
     
  for (i = 0; i < data.accessories.length; i++) {
    block_a = $(ba+data.accessories[i].name+be);
    grid.append(block_a);

    var value = data.accessories[i].value;
    if (jQuery.type(value.On) === "boolean") {
      var btn_off_elem = '<a href="#" id="btn_off'+i+'" class="btn_off ui-btn ui-mini ui-btn-inline">off</a>';
      var btn_on_elem = '<a href="#" id="btn_on'+i+'" class="btn_on ui-btn ui-mini ui-btn-inline">on</a>';
      block_b =$(bb+btn_off_elem+btn_on_elem+be);
      grid.append(block_b);
    }
    if (jQuery.type(value.CurrentTemperature) === "number") {
      block_b = $(bb+'<input id="temp'+i+'" class="temp" type="range" min="-20" max="50" value="15" data-highlight="true" data-popup-enabled="true">'+be);
      grid.append(block_b);
    }
  }
  grid.append(be);
  $("#content").append(grid);
  $("#content").trigger("create");
  
  for (i = 0; i < data.accessories.length; i++) {
    var value = data.accessories[i].value;
    if (jQuery.type(value.On) === "boolean") {
      $("#btn_off"+i).data("msg", {index: i, characteristic: "On", value: false});
      $("#btn_on"+i).data("msg", {index: i, characteristic: "On", value: true});
    }
    if (jQuery.type(value.CurrentTemperature) === "number") {
      $("#temp"+i).data("msg", {index: i, characteristic: "CurrentTemperature", value: 0});
    }
  }
  
  $(".btn_off").on("tap",  function(event) {
    var message = JSON.stringify($(this).data("msg"));
    //displayMessage("#message", message, "Tomato");
    setTimeout(function() {
      ws.send(message);
    });  
  });
  
  $(".btn_on").on("tap", function(event) {
    var message = JSON.stringify($(this).data("msg"));
    //displayMessage("#message", message, "Blue");
    setTimeout(function() {
      ws.send(message);
    });
  });
  
  $(".temp").on( "slidestop", function(event) {
    var msg = $(this).data("msg");
    msg.value = $(this).val();
    var message = JSON.stringify(msg);
    //displayMessage("#message", message, "Blue");
    setTimeout(function() {
      ws.send(message);
    });
  });
}
</script>

</head>
<body>
  <div data-role="page" id="page1">
    <div data-role="header">
      <div id="header"></div>
    </div>
    <div data-role="main" class="ui-content">
      <div id="content"></div>
    </div>
    <div data-role="footer">
      <div id="footer" class="msg"></div>
      <div id="error_msg" class="msg"></div>
      <div id="message" class="msg"></div>
      <div id="message2" class="msg"></div>
      <div id="message3" class="msg"></div>
    </div>
  </div>     
</body>
</html>