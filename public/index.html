<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="jquery.mobile-1.4.5/jquery.mobile-1.4.5.min.css" />
<link rel="stylesheet" href="homebridge-punt.css" />
<script src="jquery-2.1.4.min.js"></script>
<script src="jquery.mobile-1.4.5/jquery.mobile-1.4.5.min.js"></script>
<script>
var ws;

$(document).on("pagecreate", "#page1", function() {
  var header = document.getElementById("header");
  var menu = '<a href="#myPanel" class="menu_icon ui-btn ui-corner-all ui-btn-inline ui-icon-bars ui-btn-icon-notext"></a>';
  $(header).html('<h3 class="pleft"><span>'+menu+'<span>Simulator</span><span id="hstatus"></span><span id="btn_con"></span></h3>');
  
  $(document).ready(startWS);
});

function startWS() {
  origin = window.document.location.origin.replace(/http/, 'ws');
  ws = new WebSocket(origin);
  ws.onopen = function (event) {
    displayMessage("#hstatus", "connected", "YellowGreen");
  }
  ws.onclose = function (event) {
    displayMessage("#hstatus", "disconnected", "Tomato");
    var a ='<a href="#" id="connect" class="ui-btn ui-mini ui-corner-all ui-btn-inline ui-icon-forward ui-btn-icon-notext"</a>';
    $("#btn_con").html(a);
    
    $("#connect").on("tap",  function(event) {
      location.reload();
    });
  }
  ws.onmessage = function (event) {
    //displayMessage("#debug", event.data, "YellowGreen")
    var j_data = JSON.parse(event.data);
    switch (j_data.label.data_type) {
      case "info":
        var footer = document.getElementById("footer");
        $(footer).html('<h3>homebridge-punt <span id="version"></span></h3>');
        displayMessage("#version", "v"+j_data.label.version, "SteelBlue");
      break;
      case "value":
        updateView(j_data);
      break;
    }
  }
  ws.onerror = function (event) {
    displayMessage("#error_msg", event.data, "red");
  }
}

function displayMessage(output, message, color) {
  $(output).html('<span style="color:' + color + '">' + message + '</span>');
}

function updateView(data) {
  //displayMessage("#debug", JSON.stringify(data), "SteelBlue");
  var data_view = document.getElementById('data_view');
  if (!data_view) {
    createView(data);
    for (i = 0; i < data.accessories.length; i++) {
      parsing(i,data.accessories[i].value);
    }
  } else {
    var value;
    if (data.label.index == "all") {
      for (i = 0; i < data.accessories.length; i++) {
        parsing(i,data.accessories[i].value);
      }
    } else {
      var i = data.label.index;
      parsing(i,data.accessory.value);
    }
  }
}

function parsing(i, value) {
  if (jQuery.type(value.On) === "boolean") {
    setBtnColor(i, value.On);
  }
  if (jQuery.type(value.CurrentTemperature) === "number") {
    var ct = value.CurrentTemperature.toFixed(1);
    var temp = document.getElementById("temp"+i);
    $(temp).val(ct);
    $(temp).slider('refresh');
  }
}

function setBtnColor(i, value) {
  var btn_off = document.getElementById("btn_off"+i);
  var btn_on = document.getElementById("btn_on"+i);
  if (value) {
    $(btn_on).addClass("btn_tap");
    $(btn_off).removeClass("btn_tap");
  } else {
    $(btn_off).addClass("btn_tap");
    $(btn_on).removeClass("btn_tap");
  }
}

function createView(data) {
  //displayMessage("#debug", JSON.stringify(data), "SteelBlue");
  var grid = $('<div class="ui-grid-a ui-responsive" id="data_view">');
  var btn_class = 'ui-btn ui-mini ui-btn-inline';
  var ba = '<div class="ui-block-a">';
  var bb = '<div class="ui-block-b">';
  var be = '</div>';
  var block_a;
  var block_b;
  var log = "";
  
  for (i = 0; i < data.accessories.length; i++) {
    //log += JSON.stringify(data.accessories[i]) + "<br>";
    //displayMessage("#debug", log, "SteelBlue");
    block_a = $(ba+data.accessories[i].name+be);
    grid.append(block_a);

    var value = data.accessories[i].value;
    if (jQuery.type(value.On) === "boolean") {
      var btn_off_elem = '<a href="#" id="btn_off'+i+'" data-i="'+i+'" class="btn '+btn_class+'">off</a>';
      var btn_on_elem = '<a href="#" id="btn_on'+i+'" data-i="'+i+'" class="btn '+btn_class+'">on</a>';
      block_b =$(bb+btn_off_elem+btn_on_elem+be);
      grid.append(block_b);
    }
    if (jQuery.type(value.CurrentTemperature) === "number") {
      block_b = $(bb+'<input id="temp'+i+'" data-i="'+i+'" class="temp" type="range" min="-20" max="60" value="20" data-highlight="true" data-popup-enabled="true">'+be);
      grid.append(block_b);
    }
    if (jQuery.type(value.ContactSensorState) === "number") {
      var label = '<div>0: Contact Detected 1: Contact Not Detected</div>';      
      block_b = $(bb+'<div id="flipswitchWrapper"><select id="contact'+i+'" data-i="'+i+'" class="contact ui-flipswitch" data-role="flipswitch"><option value="1">Not Detected</option><option value="0">Detected</option></select></div>'+be);
       grid.append(block_b);
    }
  }
  grid.append(be);
  $("#content").append(grid);
  $("#content").trigger("create");

  $(".btn").on("tap",  function(event) {
    var msg = {index: $(this).data("i"), characteristic: "On", value: $(this).text() == "off" ? false: true};
    var message = JSON.stringify(msg);
    //displayMessage("#debug", message, "Blue");
    setTimeout(function() {
      ws.send(message);
    });  
  });
  
  $(".temp").on("slidestop", function(event) {
    var msg = {index: $(this).data("i"), characteristic: "CurrentTemperature", value: $(this).val()};
    var message = JSON.stringify(msg);
    //displayMessage("#debug", message, "Blue");
    setTimeout(function() {
      ws.send(message);
    });
  });
  
  $(".contact").on("change", function(event) {
    var msg = {index: $(this).data("i"), characteristic: "ContactSensorState", value: $(this).val()};
    var message = JSON.stringify(msg);
    //displayMessage("#debug", message, "Blue");
    setTimeout(function() {
      ws.send(message);
    });
  });
}
</script>

</head>
<body>
  <div data-role="page" id="page1">
  
    <div data-role="panel" id="myPanel"> 
      <h3>homebridge-punt</h3>
      <p>This is a work in progress! Please visit homebridge-punt github for the latest news. Your feedback is welcome.</p>
    </div> 
  
    <div id="header"data-role="header">
      <div id="header"></div>
    </div>
    <div data-role="main" class="ui-content">
      <div id="content"></div>
    </div>
    <div data-role="footer">
      <div id="footer" class="pleft"></div>
      <div id="error_msg" class="pleft"></div>
      <div id="message" class="pleft"></div>
      <div id="debug" class="pleft"></div>
    </div>
  </div>     
</body>
</html>