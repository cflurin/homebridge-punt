<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="jquery.mobile-1.4.5/jquery.mobile-1.4.5.min.css" />
<link rel="stylesheet" href="homebridge-punt.css" />
<script src="jquery-2.1.4.min.js"></script>
<script src="jquery.mobile-1.4.5/jquery.mobile-1.4.5.min.js"></script>
<script>
var ws;
var logmsg = "";

$(document).on("pagecreate", "#page1", function() {
  $(document).ready(startWS);
});

function startWS() {
  origin = window.document.location.origin.replace(/http/, 'ws');
  ws = new WebSocket(origin);
  ws.onopen = function (event) {
    displayMessage("#status", "connected", "YellowGreen");   
  }
  ws.onclose = function (event) {
    displayMessage("#status", "disconnected", "Tomato");   
    $("#p_reload").css("visibility", "visible");
    $("#p_reload").on("tap", function(event) {
      location.reload();
    });
  }
  ws.onmessage = function (event) {
    //log(event.data);
    var jdata = JSON.parse(event.data);
    switch (jdata.label.data_type) {
      case "info":
        $("#fc").html('homebridge-punt <span id="version"></span>');
        displayMessage("#version", "v"+jdata.label.version, "SteelBlue");
      break;
      case "value":
        updateView(jdata);
      break;
    }
  }
  ws.onerror = function (event) {
    displayMessage("#error_msg", event.data, "red");
  }
}

function displayMessage(output, message, color) {
  $(output).html('<span style="color:'+color+'">'+message+'</span>');
}

function log(message) {
  logmsg += message + '<br>';
  $("#debug").html('<span>'+logmsg+'</span>');
}

function updateView(data) {
  //log(JSON.stringify(data));
  var data_view = document.getElementById('data_view');
  if (!data_view) createView(data);
  
  if (data.label.index == "all") {
    for (i = 0; i < data.accessories.length; i++) {
      parsing(i,data.accessories[i].value);
    }
  } else {
    var i = data.label.index;
    parsing(i,data.accessory.value);
  }
}

function parsing(i, value) {
  //log(JSON.stringify(value));
  var keys = Object.keys(value);
  for (k = 0; k < keys.length; k++) {
    var c = keys[k];
    switch(c) {
      case "On":
      case "OutletInUse":
        setBtnColor(c, i, value[c]);
        break;
      case "CurrentTemperature":
      case "CurrentPosition":
      case "TargetPosition":
        p_id = setVal(c, i, value);
        $(p_id).slider("refresh");
        break;
      case  "ContactSensorState":
        p_id = setVal(c, i, value);
        $(p_id).flipswitch("refresh");
        break;
      default:
    }
  }
}

function setVal(c, i, value) {
  var v = value[c];
  var p_id = document.getElementById(c+i);
  $(p_id).val(v);
  //log(c+" "+i+" "+v);
  return p_id;
}

function setBtnColor(c, i, value) {
  var btn_off = document.getElementById("off"+c+i);
  var btn_on = document.getElementById("on"+c+i);
  if (value) {
    $(btn_on).addClass("pi-btn-tap");
    $(btn_off).removeClass("pi-btn-tap");
  } else {
    $(btn_off).addClass("pi-btn-tap");
    $(btn_on).removeClass("pi-btn-tap");
  }
}

function createView(data) {
  //log(JSON.stringify(data));
  var grid = $('<div class="ui-grid-b ui-responsive pi-grid" id="data_view">');
  var ba = '<div class="ui-block-a">';
  var bb = '<div class="ui-block-b">';
  var bc = '<div class="ui-block-c">';
  var be = '</div>';
  var blocka, blockb, blockc;
  var html = "";
  
  for (i = 0; i < data.accessories.length; i++) {
    //log(JSON.stringify(data.accessories[i]));    
    var value = data.accessories[i].value;
    var keys = Object.keys(value);
    //log("keys "+keys);
    
    for (k = 0; k < keys.length; k++) {
      var c = keys[k];
      //log("c= >"+c+"<"+" "+ keys.length);
      switch(c) {
        case "On":
          html = '<a href="#" id="off'+c+i+'" data-i="'+i+'" data-c="'+c+'" class="onoff pi-btn ui-btn ui-mini ui-btn-inline">off</a>';
          html += '<a href="#" id="on'+c+i+'" data-i="'+i+'" data-c="'+c+'" class="onoff pi-btn ui-btn ui-mini ui-btn-inline">on</a>';
        break;
        case "OutletInUse":
          html = '<a href="#" id="off'+c+i+'" data-i="'+i+'" data-c="'+c+'" class="onoff pi-btn ui-btn ui-mini ui-btn-inline">off</a>';
          html += '<a href="#" id="on'+c+i+'" data-i="'+i+'" data-c="'+c+'" class="onoff pi-btn ui-btn ui-mini ui-btn-inline">on</a>';
        break;
        case "CurrentTemperature":
          html = '<input id="'+c+i+'" data-i="'+i+'" data-c="'+c+'" class="nr" type="range" min="-20" max="60" step="0.1" value="20" data-highlight="true" data-popup-enabled="true">';
          break;
        case "CurrentPosition":
          html = '<input id="'+c+i+'" data-i="'+i+'" data-c="'+c+'" class="nr" type="range" min="0" max="100" value="0" data-highlight="true" data-popup-enabled="true">';
          break;
        case "TargetPosition":
          html = '<input id="'+c+i+'" data-i="'+i+'" data-c="'+c+'" class="nr" type="range" min="0" max="100" value="0" data-highlight="true" data-popup-enabled="true">';
          break;
        case "ContactSensorState":
          html = '<div id="flipswitchWrapper"><select id="'+c+i+'" data-i="'+i+'" data-c="'+c+'" class="nr" ui-flipswitch" data-role="flipswitch"><option value="1">Not Detected</option><option value="0">Detected</option></select></div>';
          break;
        default:
      }
      if (k == 0) { blocka = $(ba+data.accessories[i].name+be); }
      else { blocka = $('<div class="ui-block-a" style="border-top: none">'+be); }
      grid.append(blocka);
      blockb = $(bb+c+be);
      grid.append(blockb);
      blockc = $(bc+html+be);
      grid.append(blockc);
    }
  }
  grid.append(be);
  $("#content").append(grid);
  $("#content").trigger("create");

  $(".onoff").on("tap",  function(event) {
    var msg = {index: $(this).data("i"), characteristic: $(this).data("c"), value: $(this).text() == "off" ? false: true};
    var message = JSON.stringify(msg);
    //log(message);
    setTimeout(function() {
      ws.send(message);
    });  
  });
    
  $(".nr").on("change", function(event) {
    var msg = {index: $(this).data("i"), characteristic: $(this).data("c"), value: $(this).val()};
    var message = JSON.stringify(msg);
    //log(message);
    setTimeout(function() {
      ws.send(message);
    });
  });
}
</script>

</head>
<body>
  <div data-role="page" id="page1">
  
    <div data-role="panel" id="panel1"> 
      <h3>homebridge-punt</h3>
      <p>This is a work in progress! Please visit homebridge-punt github for the latest news. Your feedback is welcome.</p>
    </div> 
  
    <div data-role="header">
      <a href="#panel1" class="pi-btn-h ui-btn ui-nodisc-icon ui-corner-all ui-icon-bars ui-btn-icon-left"></a>
      <h3>Simulator<span id="status" class="pi-lb"></span></h3>
      <a href="#" id="p_reload" class="pi-btn-h pi-btn-vh ui-btn ui-nodisc-icon ui-corner-all ui-icon-refresh ui-btn-icon-right"></a>
    </div>
    <div data-role="main" class="ui-content">
      <div id="content"></div>
    </div>
    <div data-role="footer">
      <h1 id="fc"></h1>
      <div id="error_msg" class="pi-la"></div>
      <div id="message" class="pi-la"></div>
      <div id="debug" class="pi-la"></div>
    </div>
  </div>     
</body>
</html>